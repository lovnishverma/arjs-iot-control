<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  
  <a-scene embedded arjs cursor="rayOrigin: mouse" raycaster="objects: .clickable">
    
    <!-- Hiro Marker -->
    <a-marker preset="hiro">
      
      <!-- Toggle Switch (Smaller & Clickable) -->
      <a-cylinder id="switch" class="clickable"
                  position="0 0.1 0" radius="0.1" height="0.05"
                  color="#ff0000">
        <a-animation attribute="scale" from="1 1 1" to="1.2 1.2 1.2" direction="alternate"
                     repeat="indefinite" dur="600"></a-animation>
      </a-cylinder>

      <!-- Status Text -->
      <a-text id="status-text" value="Loading..." position="-0.4 0.4 0" 
              color="white" align="center" scale="0.5 0.5 0.5"></a-text>

    </a-marker>

    <!-- Camera -->
    <a-entity camera position="0 0 2">
      <!-- Cursor for clicking -->
      <a-cursor color="white"></a-cursor>
    </a-entity>
    
  </a-scene>

  <script>
    const switchEl = document.getElementById("switch");
    const statusText = document.getElementById("status-text");
    const apiUrl = "https://roomcontrol.glitch.me/app-status";
    const toggleUrl = "https://roomcontrol.glitch.me/toggle-app?state=";

    // Fetch current status from API
    async function fetchStatus() {
      try {
        const response = await fetch(apiUrl, { method: 'GET' });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const data = await response.json();
        updateSwitch(data.status);
      } catch (error) {
        console.error("Error fetching status:", error);
        statusText.setAttribute("value", "Error: Failed to fetch status");
      }
    }

    // Update switch color & status text
    function updateSwitch(status) {
      if (status === "on") {
        switchEl.setAttribute("color", "#00ff00"); // Green for ON
        statusText.setAttribute("value", "Status: ON");
      } else {
        switchEl.setAttribute("color", "#ff0000"); // Red for OFF
        statusText.setAttribute("value", "Status: OFF");
      }
    }

    // Toggle switch status via API
    async function toggleSwitch() {
      const currentStatus = statusText.getAttribute("value").includes("ON") ? "off" : "on";
      try {
        const response = await fetch(toggleUrl + currentStatus, { method: 'GET' });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        updateSwitch(currentStatus);
      } catch (error) {
        console.error("Error toggling status:", error);
        statusText.setAttribute("value", "Error: Failed to toggle state");
      }
    }

    // Click listener for the switch
    switchEl.addEventListener("click", toggleSwitch);

    // Fetch initial switch status
    fetchStatus();
  </script>

</body>
</html>
