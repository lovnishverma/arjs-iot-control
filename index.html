<!DOCTYPE html>
<html>
  <head>
    <title>Enhanced VR Toggle Switch</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <style>
      .progress-bar {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 300px;
        height: 20px;
        background: rgba(0, 0, 0, 0.5);
      }
      .progress-fill {
        height: 100%;
        width: 0;
        background-color: green;
      }
    </style>
  </head>
  <body>
    <!-- Progress bar for gaze time feedback -->
    <div class="progress-bar">
      <div id="progress" class="progress-fill"></div>
    </div>

    <a-scene>
      <!-- Define the switch -->
      <a-box id="switch" position="0 1.5 -3" depth="0.2" height="0.5" width="0.5" color="#4CC3D9">
        <a-text value="OFF" position="0 0 0.3" scale="1 1 1" color="#FFFFFF" id="switchText"></a-text>
      </a-box>
      
      <!-- VR Camera with gaze controls -->
      <a-camera id="camera" position="0 1.6 0" wasd-controls="enabled: false" look-controls="enabled: true">
      </a-camera>
      
      <!-- Sound feedback -->
      <a-sound id="toggleSound" src="url(https://www.soundjay.com/button/beep-07.wav)" position="0 2 0" autoplay="false"></a-sound>
    </a-scene>

    <script>
      // Initialize variables
      let gazeTimer;
      let switchElement = document.querySelector("#switch");
      let switchText = document.querySelector("#switchText");
      let progressBar = document.querySelector("#progress");
      let toggleSound = document.querySelector("#toggleSound");
      let state = "off"; // Initial state is "off"

      // Function to send requests
      function sendToggleRequest(state) {
        fetch(`https://roomcontrol.glitch.me/toggle-app?state=${state}`)
          .then(response => response.text())
          .then(data => console.log(data))
          .catch(error => console.error('Error:', error));
      }

      // Function to update the progress bar and handle state change
      function updateProgressBar(time) {
        let progress = Math.min(time / 2000, 1);  // Progress bar maxes out at 2 seconds
        progressBar.style.width = (progress * 100) + "%";

        // If time exceeds 2 seconds, toggle the state
        if (time >= 2000) {
          if (state === "off") {
            state = "on";
            switchElement.setAttribute('color', '#FF5733');
            switchText.setAttribute('value', 'ON');
            sendToggleRequest("on");
            toggleSound.components.sound.playSound();
          } else {
            state = "off";
            switchElement.setAttribute('color', '#4CC3D9');
            switchText.setAttribute('value', 'OFF');
            sendToggleRequest("off");
            toggleSound.components.sound.playSound();
          }
        }
      }

      // Function to check gaze interaction
      function checkGaze() {
        const camera = document.querySelector('#camera');
        const switchPosition = switchElement.getAttribute('position');
        const cameraPosition = camera.getAttribute('position');
        
        // Simple distance calculation to check if the user is gazing at the switch
        const distance = Math.sqrt(Math.pow(cameraPosition.x - switchPosition.x, 2) +
                                   Math.pow(cameraPosition.y - switchPosition.y, 2) +
                                   Math.pow(cameraPosition.z - switchPosition.z, 2));

        if (distance < 2) {  // If the user is within 2 meters of the switch
          // Start timer when gaze is within range
          if (!gazeTimer) {
            gazeTimer = Date.now();
          }

          // Update progress bar as the user gazes
          let elapsedTime = Date.now() - gazeTimer;
          updateProgressBar(elapsedTime);
        } else {
          // Reset progress if the user moves away
          gazeTimer = null;
          progressBar.style.width = "0%";
        }
      }

      // Continuously check for gaze
      setInterval(checkGaze, 100);
    </script>
  </body>
</html>
