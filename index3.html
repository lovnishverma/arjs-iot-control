<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js/aframe/build/aframe-ar.js"></script>
  </head>
  <body style="margin: 0px; overflow: hidden">
    <a-scene stats embedded arjs="trackingMethod: best; sourceType: webcam;">
      <!-- Hiro Marker -->
      <a-marker preset="hiro" id="hero-marker">
        <!-- 3D Box to show when marker is detected -->
        <a-box id="switch-box" position="0 0.5 0" material="color: red; opacity: 0.5;" scale="1 1 1"></a-box>
      </a-marker>

      <!-- Camera -->
      <a-camera></a-camera>
    </a-scene>

    <script>
      const switchBox = document.getElementById('switch-box');
      const heroMarker = document.getElementById('hero-marker');

      let debounceTimer;  // To store debounce timer
      const debounceDelay = 500;  // 500ms delay for debouncing

      // Check for the marker and update the switch state accordingly
      heroMarker.addEventListener('markerFound', function () {
        console.log('Marker found!');
        clearTimeout(debounceTimer);  // Clear any existing timer
        debounceTimer = setTimeout(() => {
          updateSwitchState('on');
        }, debounceDelay);  // Call after 500ms
      });

      heroMarker.addEventListener('markerLost', function () {
        console.log('Marker lost!');
        clearTimeout(debounceTimer);  // Clear any existing timer
        debounceTimer = setTimeout(() => {
          updateSwitchState('off');
        }, debounceDelay);  // Call after 500ms
      });

      // Function to call the API and update the switch state
      function updateSwitchState(state) {
        const url = `https://roomcontrol.glitch.me/toggle-app?state=${state}`;

        fetch(url)
          .then((response) => response.text())  // Use .text() instead of .json() to handle plain text response
          .then((data) => {
            console.log(data);  // Log the response from the server (e.g., "App turned on" or "App turned off")
            if (data === "App turned on") {
              console.log("Switch is now ON");
              switchBox.setAttribute('material', 'color', 'green');  // Change box color to green when ON
            } else if (data === "App turned off") {
              console.log("Switch is now OFF");
              switchBox.setAttribute('material', 'color', 'red');  // Change box color to red when OFF
            }
          })
          .catch((error) => {
            console.error('Error updating switch state:', error);
          });
      }
    </script>
  </body>
</html>
